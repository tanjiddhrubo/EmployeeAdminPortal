@using EmployeeAdminClient.Models
@using Microsoft.AspNetCore.Http
@{
    ViewData["Title"] = "Employee List";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>Employee List</h1>
        <button id="addEmployeeBtn" class="btn btn-success" onclick="location.href='@Url.Action("AddEdit", "Employee")'">
            <i class="fas fa-plus"></i> Add New Employee
        </button>
    </div>

    <div id="loadError" class="mb-2 text-danger"></div>

    <table class="table table-bordered table-striped" id="employeeTable">
        <thead>
            <tr>
                <th>Full Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Salary</th>
                <th>Department</th>
                <th>Designation</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="7" class="text-center">Loading employees...</td></tr>
        </tbody>
    </table>
</div>

@section Scripts {
    <script>
        // Store the API Base URL from the ViewBag
        const API_BASE_URL = '@ViewBag.ApiBaseUrl';

        // Retrieve the JWT token from the session using Razor
        const JWT_TOKEN = "@Context.Session.GetString("JwtToken")";

        if (!JWT_TOKEN) {
            // No token -> go to login (logout clears any stale session)
            location.href = '@Url.Action("Logout", "Auth")';
        }

        // ⭐️ CORE AJAX FUNCTION: Fetch all employees ⭐️
        function loadEmployees() {
            const $tbody = $('#employeeTable tbody');
            $tbody.html('<tr><td colspan="7" class="text-center">Loading employees...</td></tr>'); // Loading message
            $('#loadError').empty();

            $.ajax({
                url: API_BASE_URL + '/api/employees',
                method: 'GET',
                contentType: 'application/json',
                headers: {
                    'Authorization': 'Bearer ' + JWT_TOKEN
                },
                success: function(employees) {
                    $tbody.empty(); // Clear loading message

                    if (!employees || employees.length === 0) {
                        $tbody.append('<tr><td colspan="7" class="text-center">No employees found.</td></tr>');
                        return;
                    }

                    const employeeData = (typeof employees === 'string') ? JSON.parse(employees) : employees;

                    $.each(employeeData, function(index, employee) {
                        const row = `
                            <tr data-id="${employee.id}">
                                <td>${employee.name}</td>
                                <td>${employee.email}</td>
                                <td>${employee.phone ?? ''}</td>
                                <td>${employee.salary}</td>
                                <td>${employee.departmentName ?? ''}</td>
                                <td>${employee.designationName ?? ''}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary me-1" onclick="location.href='@Url.Action("AddEdit","Employee")?id=${employee.id}'">Edit</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteEmployee('${employee.id}')">Delete</button>
                                </td>
                            </tr>`;
                        $tbody.append(row);
                    });
                },
                error: function(xhr) {
                    console.error('Failed to load employees', xhr);
                    let extra = '';
                    try {
                        if (xhr.responseText) {
                            console.error('Response body:', xhr.responseText);
                            const body = JSON.parse(xhr.responseText);
                            extra = body.message || JSON.stringify(body);
                        }
                    } catch (e) {
                        console.error('Could not parse response body', e);
                    }

                    $('#loadError').text('Error loading data. See console. ' + (extra ? ('Details: ' + extra) : ''));
                    $tbody.html('<tr><td colspan="7" class="text-center">Error loading data. See console.</td></tr>');

                    // If 401 or 403 redirect to login
                    if (xhr.status === 401 || xhr.status === 403) {
                        setTimeout(function() { location.href = '@Url.Action("Logout", "Auth")'; }, 800);
                    }
                }
            });
        }

        function deleteEmployee(id) {
            if (!confirm('Delete this employee?')) return;

            $.ajax({
                url: API_BASE_URL + '/api/employees/' + id,
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + JWT_TOKEN },
                success: function() { loadEmployees(); },
                error: function(xhr) { alert('Delete failed: ' + xhr.status); }
            });
        }

        $(document).ready(function() { loadEmployees(); });
    </script>
}